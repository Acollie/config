# ============================================================================
# Tmux Configuration with Powerline Theme, System Stats, and Git Integration
# ============================================================================

# ============================================================================
# PLUGIN MANAGER (TPM) INITIALIZATION
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# ============================================================================
# CORE SETTINGS
# ============================================================================

# Set base index to 1 (more intuitive than 0)
set -g base-index 1
setw -g pane-base-index 1

# Increase history limit
set -g history-limit 10000

# Set terminal type
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:RGB"

# Status bar refresh interval (in seconds)
set -g status-interval 2

# Enable mouse support
set -g mouse on

# Vi mode in copy mode
setw -g mode-keys vi

# Faster escape time (better for vim)
set -s escape-time 10

# Enable focus events
set -g focus-events on

# ============================================================================
# VISUAL THEME - POWERLINE STYLE
# ============================================================================

# Color palette
set -g status-bg "#2e3440"
set -g status-fg "#eceff4"

# Window list styling
set -g window-status-format "#[fg=#4c566a,bg=#2e3440] #I #W "
set -g window-status-current-format "#[fg=#2e3440,bg=#88c0d0]#[fg=#2c3e50,bold] #I #W #[fg=#88c0d0,bg=#2e3440]"

# Pane borders
set -g pane-border-style "fg=#3b4252"
set -g pane-active-border-style "fg=#88c0d0"

# Message styling
set -g message-style "fg=#eceff4,bg=#3b4252"
set -g message-command-style "fg=#eceff4,bg=#3b4252"

# ============================================================================
# STATUS BAR CONFIGURATION - POWERLINE LAYOUT
# ============================================================================

# LEFT SIDE: Session info + prefix highlight + uptime
# Format: "Session: XhYm | prefix-highlight"
set -g status-left-length 60
set -g status-left "#[fg=#eceff4,bg=#4c566a,bold] #S #[fg=#4c566a,bg=#2e3440]#[fg=#eceff4,bg=#2e3440] Session: #(tmux display -p '#{session_created}' | xargs -I {} bash -c 'echo $((($(($(date +%s) - {})) / 3600)))h $((($(($(date +%s) - {})) % 3600) / 60))m') #[default]#{prefix_highlight}"

# RIGHT SIDE: Git + CPU + RAM + Battery + Time
# Format: "Git | CPU: % | RAM: % | BATT: % | HH:MM"
set -g status-right-length 140
set -g status-right "#[fg=#b48ead,bg=#2e3440] #(git -C #{pane_current_path} branch --show-current 2>/dev/null || echo 'âˆ…') #(git -C #{pane_current_path} diff --numstat 2>/dev/null | awk '{a+=$1; d+=$2} END {if (a>0 || d>0) print \"+\"a\" -\"d}') #[fg=#2e3440,bg=#2e3440]#[fg=#eceff4,bg=#3b4252] CPU:#{cpu_percentage}#[default] #[fg=#2e3440,bg=#2e3440]#[fg=#eceff4,bg=#3b4252] RAM:#{ram_percentage}#[default] #[fg=#2e3440,bg=#2e3440]#[fg=#eceff4,bg=#3b4252] BATT:#{battery_percentage}#[default] #[fg=#2e3440,bg=#2e3440]#[fg=#eceff4,bg=#3b4252] %H:%M #[fg=#2e3440,bg=#3b4252]"

# ============================================================================
# PLUGIN CONFIGURATION
# ============================================================================

# CPU Plugin
set -g @cpu_percentage_format "%5.1f%%"
set -g @ram_percentage_format "%5.1f%%"

# Battery Plugin - More control with styling
set -g @batt_remain_short true

# Prefix Highlight
set -g @prefix_highlight_fg white
set -g @prefix_highlight_bg red
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr "fg=white,bg=cyan"

# vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" { send-keys C-h } { select-pane -L }
bind -n C-j if-shell "$is_vim" { send-keys C-j } { select-pane -D }
bind -n C-k if-shell "$is_vim" { send-keys C-k } { select-pane -U }
bind -n C-l if-shell "$is_vim" { send-keys C-l } { select-pane -R }
bind -n C-\\ if-shell "$is_vim" { send-keys "C-\\" } { select-pane -l }

# ============================================================================
# KEY BINDINGS
# ============================================================================

# Change prefix to Ctrl-a (optional, uncomment if desired)
# set -g prefix C-a
# unbind C-b
# bind C-a send-prefix

# Split window bindings with better mnemonics
unbind %
bind | split-window -h -c "#{pane_current_path}"

unbind '"'
bind - split-window -v -c "#{pane_current_path}"

# New window in current directory
bind c new-window -c "#{pane_current_path}"

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# Easy pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Window navigation
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# Pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Enter copy mode with space
bind Space copy-mode
bind -T copy-mode-vi Space send-keys -X begin-selection
bind -T copy-mode-vi Enter send-keys -X copy-selection-and-cancel

# Paste with p
bind p paste-buffer

# ============================================================================
# TPM INITIALIZATION (MUST BE AT END)
# ============================================================================

run '~/.tmux/plugins/tpm/tpm'
